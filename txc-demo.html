<html>
<head>
    <title>OpenXC trace player</title>
    <script type="text/javascript" src="AFB.js"></script>
    <script type="text/javascript">
	var afb = new AFB("api", "hello");
	var ws;
	var curLat = undefined, prvLat = undefined;
	var curLon = undefined, prvLon = undefined;
	var vspeed = 0, espeed = 0;
	var heading = 0;
	var R2D = 180.0 / Math.PI;
	var D2R = Math.PI / 180.0;
	var ximg = null;
	var yimg = null;
	var gapikey = "AIzaSyBG_RlEJr2i7zqJVQijKh4jQrE-DkeHau0"
	var mapikey = "AIzaSyD4Sbh8-imto8EO7HP3uteQl6WRJaHwVOU"
	var minspeed = 5;

	function updatePosition() {
		if (curLat !== undefined && curLon !== undefined) {
			if (prvLat !== undefined && prvLon !== undefined && vspeed >= minspeed) {
				heading = Math.round(R2D * Math.atan2((curLon - prvLon)/Math.cos(D2R*curLat), curLat - prvLat));
				document.getElementById("hea").innerHTML = String(heading);
				document.getElementById("car").style = "transform: rotate("+heading+"deg);";
			}

			document.getElementById("view1").src = "http://maps.googleapis.com/maps/api/streetview?key="+gapikey+"&size=480x320&location="+curLat+","+curLon+"&heading="+heading;
			document.getElementById("view2").src = "http://maps.googleapis.com/maps/api/staticmap?key="+mapikey+"&maptype=hybrid&zoom=18&size=480x320&center="+curLat+","+curLon;

		}
	}

	function gotLatitude(obj) {
		prvLat = curLat;
		curLat = obj.data.value;
		document.getElementById("lat").innerHTML = String(curLat);
		updatePosition();
	}

	function gotLongitude(obj) {
		prvLon = curLon;
		curLon = obj.data.value;
		document.getElementById("lon").innerHTML = String(curLon);
		updatePosition();
	}

	function gotVehicleSpeed(obj) {
		vspeed = Math.round(obj.data.value);
		document.getElementById("vsp").innerHTML = String(vspeed);
		document.getElementById("vspeed").innerHTML = String(vspeed);
	}

	function gotEngineSpeed(obj) {
		espeed = Math.round(obj.data.value);
		document.getElementById("esp").innerHTML = String(espeed);
		document.getElementById("espeed").innerHTML = String(espeed);
	}

	function gotStart(obj) {
	}

	function gotStop(obj) {
	}

	function onAbort() {
		document.getElementById("main").style.visibility = "hidden";
		document.getElementById("connected").innerHTML = "Connected Closed";
	}
	function onOpen() {
		ws.call("txc/subscribe", {event:["longitude","latitude","vehicle_speed","engine_speed","START","STOP"]}).then(onSubscribed, onAbort);
	}

	function onSubscribed() {
		document.getElementById("main").style.visibility = "visible";
		document.getElementById("connected").innerHTML = "Connected to player of openXC traces";
		ws.onevent("txc/longitude", gotLongitude);
		ws.onevent("txc/latitude", gotLatitude);
		ws.onevent("txc/vehicle_speed", gotVehicleSpeed);
		ws.onevent("txc/engine_speed", gotEngineSpeed);
		ws.onevent("txc/START", gotStart);
		ws.onevent("txc/STOP", gotStop);
	}

	function replyok(obj) {
		document.getElementById("output").innerHTML = "OK: "+JSON.stringify(obj);
	}
	function replyerr(obj) {
		document.getElementById("output").innerHTML = "ERROR: "+JSON.stringify(obj);
	}
	function gotevent(obj) {
		document.getElementById("outevt").innerHTML = JSON.stringify(obj);
	}
	function send(message) {
		var api = document.getElementById("api").value;
		var verb = document.getElementById("verb").value;
		ws.call(api+"/"+verb, {data:message}).then(replyok, replyerr);
	}

	function doStart(fname) {
		var x = [
			'nyc-downtown-crosstown.json',
			'nyc-uptown-west.json',
			'localwithgps.json'
		];
		ws.call('txc/start',{filename: fname});
	}

	function doStop() {
		ws.call('txc/stop',true);
	}

	function init() {
		ws = new afb.ws(onOpen, onAbort);
	}
    </script>

<body onload="init();" style="background: #012; color: white;">
    <h1></h1>
    <div id="connected">Not Connected</div>
    <div id="main" style="visibility:hidden">
        <div>
            <input type="button" value="start NYC: Downtown, Crosstown" onclick="doStart('nyc-downtown-crosstown.json');"/>
        </div>
        <div>
            <input type="button" value="start NYC: West Uptown" onclick="doStart('nyc-uptown-west.json');"/>
        </div>
        <div>
            <input type="button" value="start Highway Commute and Local Stop" onclick="doStart('localwithgps.json');"/>
        </div>
        <div>
            <input type="button" value="stop" onclick="doStop();" />
        </div>
        <div style="position: relative; height: 320px; width: 960px;">
          <div style="position: absolute; top: 0px; left: 0px;">
            <img id="view1" height="320" width="480" src="https://upload.wikimedia.org/wikipedia/commons/7/73/France_road_sign_CE.svg"/>
            <div style="position: absolute; bottom: 25px; left: 25px;">
              <svg height="100" width="100"> <circle cx="50" cy="50" r="49" stroke="white" stroke-width="3"/> <text x="30" y="80" fill="white">km/h</text> </svg>
              <div id="vspeed" style="position: absolute; top: 16px; left: 0px; width: 100px; height: 100px; color: cyan; text-align: center; vertical-align: middle; font: italic bold 42px monospace;">0</div>
            </div>
            <div style="position: absolute; bottom: 25px; right: 25px; width: 100px; height: 100px;">
              <svg height="100" width="100"> <circle cx="50" cy="50" r="49" stroke="white" stroke-width="3"/> <text x="30" y="80" fill="white">rpm</text> </svg>
              <div id="espeed" style="position: absolute; top: 30px; left: 0px; width: 100px; height: 100px; color: green; text-align: center; vertical-align: middle; font: italic bold 28px monospace;">0</div>
            </div>
          </div>
          <div style="position: absolute; top: 0px; left: 480px;">
            <img id="view2" height="320" width="480" src="https://upload.wikimedia.org/wikipedia/commons/e/e0/France_road_sign_CE26.svg"/>
            <div style="position: absolute; top: 136px; left: 228px;"><img id="car" src="car-top-view.png"/></div>
          </div>
        </div>
        <div>
            <div>LAT: <span id="lat">?</span> degree</div>
            <div>LON: <span id="lon">?</span> degree</div>
            <div>HEA: <span id="hea">?</span> degree</div>
            <div>VSP: <span id="vsp">0</span> km/h</div>
            <div>ESP: <span id="esp">0</span> tr/mn</div>
        </div>
    </div>

